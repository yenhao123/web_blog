<?php

	$severname = "localhost";
	$username = "root";
	$password = "a407410040";
	$database = "iot";
	$port = 3306;

	//connect
	
	$conn = new mysqli($severname,$username,$password,$database,$port);
	if($conn->connect_error){
		die("Connection failed:".$conn->connect_error);
	}
	echo "Connected successfully";
	 

	$ips = array();
	$query_ip = "select * from ip_1";
	$res_ip = $conn->query($query_ip);
	if($res_ip->num_rows>0){
		while($row = $res_ip->fetch_assoc()){
			$ip = $row["ip"];
			echo $ip;
			array_push($ips,$ip);	
		}
		$res_ip->free();
	}

	$port_info = array();
	$cve_info = array();
	for($i=0;$i<count($ips);$i++){
		$query_port = "select * from port_1 where port_ip = '".$ips[$i]."'";
		$res_port = $conn->query($query_port);
		$ports = array();
		if($res_port->num_rows>0){
			while($row = $res_port->fetch_assoc()){
				$port = $row["port"];
				array_push($ports,$port);
			}
		}
		$port_info[$ips[$i]] = $ports;
		
		$query_cve = "select * from cve_1 where cve_ip = '".$ips[$i]."'";
		$res_cve = $conn->query($query_cve);
		$cves = array();
		if($res_cve->num_rows>0){
			while($row = $res_cve->fetch_assoc()){
				$cve= $row["cve_id"];
				echo $cve;
				array_push($cves,$cve);
			}
		}
		$cve_info[$ips[$i]] = $cves;
	}
	var_dump($cve_info); 
	
	//write to file
	$f = fopen("info.txt","w");
	for($i=0;$i<count($ips);$i++){
		fwrite($f,"***".$ips[$i]."\n");
		for($j=0;$j<count($port_info[$ips[$i]]);$j++){
			fwrite($f,"///".$port_info[$ips[$i]][$j]."\n");
		}
		for($k=0;$k<count($cve_info[$ips[$i]]);$k++){
			fwrite($f,"%%%".$cve_info[$ips[$i]][$k]."\n");
		}
	}
	fclose($f);
	
	//close
	$conn->close();
	
?>
